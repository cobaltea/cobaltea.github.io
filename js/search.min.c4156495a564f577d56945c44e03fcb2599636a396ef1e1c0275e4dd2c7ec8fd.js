(function(){if(window.__search_initialized__)return;window.__search_initialized__=!0,console.log("[Search] Initializing...");const e={minQueryLength:1,maxResults:10,debounceDelay:300};class t{constructor(){if(this.data=[],this.input=document.getElementById("search-input"),!this.input){console.error("[Search] 搜索输入框元素未找到");return}this.container=this.createContainer(),this.attachEvents()}async initialize(){try{this.data=await this.loadData(),console.log(`[Search] 已加载 ${this.data.length} 条数据`)}catch(e){console.error("[Search] 初始化失败:",e),this.showError("搜索功能初始化失败")}}createContainer(){const e=document.createElement("div");e.id="search-results",e.className="search-results-container";const t=this.input.closest(".nav-link-search")||this.input.closest(".nav-item")||document.body;return t.style.position="relative",t.appendChild(e),e}attachEvents(){this.input.removeEventListener("input",this.handleInputBound),this.input.removeEventListener("keydown",this.handleKeyDownBound),document.removeEventListener("click",this.handleDocumentClickBound),this.handleInputBound=e=>{this.handleInput(e.target.value)},this.handleKeyDownBound=e=>{e.key==="Escape"&&this.hideResults()},this.handleDocumentClickBound=e=>{e.target.closest("#search-input, #search-results")||this.hideResults()},this.input.addEventListener("input",this.handleInputBound),this.input.addEventListener("keydown",this.handleKeyDownBound),document.addEventListener("click",this.handleDocumentClickBound),console.log("[Search] 事件监听器已绑定",{input:this.input,hasInputListener:!!this.input.oninput})}handleInput=this.debounce(t=>{if(t=t.trim(),console.log("[Search] 输入事件触发:",t),t.length<e.minQueryLength){this.showMessage(`输入至少${e.minQueryLength}个字符`);return}const n=this.search(t);this.displayResults(n,t)},e.debounceDelay);search(t){const n=t.toLowerCase();return this.data.map(e=>{const s=e.content.toLowerCase(),t=s.indexOf(n);if(t>=0){const o=Math.max(0,t-30),i=Math.min(s.length,t+n.length+70);e.excerpt=e.content.substring(o,i)}else e.excerpt=e.content.substring(0,120);return e}).filter(e=>[e.title,e.content].some(e=>e&&e.toLowerCase().includes(n))).slice(0,e.maxResults)}displayResults(e,t){this.container.innerHTML=e.length?e.map(e=>this.createResultHTML(e,t)).join(""):`<div class="search-no-results">未找到"${t}"相关结果</div>`,this.container.classList.add("visible")}createResultHTML(e,t){return`
        <div class="search-result">
            <a href="${e.url}" class="search-title">
                ${this.highlight(e.title,t)}
            </a>
            ${e.date?`<div class="search-date">${e.date}</div>`:""}
            <div class="search-excerpt">
                ...${this.highlight(e.excerpt,t)}...
            </div>
        </div>
    `}debounce(e,t){let n;return(...s)=>{clearTimeout(n),n=setTimeout(()=>e.apply(this,s),t)}}highlight(e,t){return e.replace(new RegExp(t.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),"gi"),e=>`<span class="search-highlight">${e}</span>`)}showMessage(e){this.container.innerHTML=`<div class="search-message">${e}</div>`,this.container.classList.remove("visible")}showError(e){this.container.innerHTML=`
                <div class="search-error">
                    ${e}<br>
                    <small>请刷新页面重试</small>
                </div>
            `}hideResults(){this.container.classList.remove("visible")}async loadData(){const e=await fetch("/search.json");if(!e.ok)throw new Error(`HTTP ${e.status}`);const t=await e.json();return Array.isArray(t)?t:[]}}document.addEventListener("DOMContentLoaded",()=>{if(document.getElementById("search-input")){const e=new t;e.initialize(),setTimeout(()=>{const e=document.getElementById("search-input");console.log("[Search] 输入框事件监听状态:",{input:e,eventListeners:getEventListeners(e)})},1e3)}})})()